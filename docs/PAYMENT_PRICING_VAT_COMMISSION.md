# الدفع، المحفظة، النقاط، الضريبة وعمولة التطبيق

## نظرة عامة

- **ضريبة القيمة المضافة (VAT):** 14.5% (قيمة افتراضية، قابلة للتعديل من إعدادات النظام `VAT_RATE`).
- **عمولة التطبيق:** نسبة مئوية من مبلغ الخدمة (قبل الضريبة)، القيمة الافتراضية 10% (قابلة للتعديل من `PLATFORM_COMMISSION_PERCENT`).
- **المحفظة:** كل مستخدم له محفظة (رصيد متاح، رصيد معلق، نقاط).
- **النقاط:** إعداد تحويل من نقاط إلى عملة من لوحة الأدمن.

---

## ما يراه العميل (المستخدم)

| البند | الوصف |
|------|--------|
| **سعر الخدمات (المجموع الفرعي)** | مجموع أسعار الخدمات المختارة قبل الضريبة وأي خصم. |
| **الخصم** | إن وُجد (كوبون، إلخ). |
| **المبلغ بعد الخصم** | المجموع الفرعي − الخصم. |
| **رسوم إضافية** | مثل رسوم ونش (flatbed) إن وُجدت. |
| **ضريبة القيمة المضافة (14.5%)** | تُحسب على (المبلغ بعد الخصم + أي رسوم خاضعة للضريبة). |
| **الإجمالي النهائي** | المبلغ الذي يدفعه العميل = بعد الخصم + الرسوم + الضريبة. |

في **الحجوزات:** الحقول `subtotal`, `discount`, `tax`, `totalPrice`, `flatbedFee` (إن وُجدت) في استجابة الحجز تعكس ما يراه العميل.

في **طلبات المتجر:** الحقول `subtotal`, `tax`, `shippingCost`, `totalAmount` تعكس ما يدفعه العميل.

---

## ما يراه الفيندور

| البند | الوصف |
|------|--------|
| **صافي المستحق له** | مبلغ الخدمة بعد خصم **عمولة التطبيق** (حسب النسبة المُعدّة في النظام). لا يشمل الضريبة في حسابه؛ الضريبة تدفعها المنصة للجهة الضريبية. |
| **عمولة التطبيق** | نسبة من مبلغ الخدمة (قبل الضريبة) تُخصم لصالح المنصة؛ يمكن أن تظهر له في تقارير/فواتير إذا تم تطبيق ذلك لاحقاً. |

المعادلة:

- **صافي الفيندور** = (المبلغ بعد الخصم للخدمات التابعة له) − (عمولة التطبيق على هذا المبلغ).
- **عمولة التطبيق** = (المبلغ بعد الخصم) × `PLATFORM_COMMISSION_PERCENT` / 100.

حالياً لا يوجد في الواجهة تفصيل جاهز "ما يراه الفيندور" مقابل "ما يراه العميل"؛ يمكن استخدام الدالة `computeServiceBreakdown` من `src/utils/pricing.js` لعرض هذا التفصيل في لوحة الفيندور أو في تقارير الدفع.

---

## إعدادات النظام (SystemSettings)

| المفتاح | الوصف | القيمة الافتراضية |
|---------|--------|---------------------|
| `VAT_RATE` | نسبة الضريبة **بالمئة** (مثلاً 14.5 للسعودية). تُخزَّن في الداتابيز كنسبة مئوية وليس 0–1 | `14.5` |
| `PLATFORM_COMMISSION_PERCENT` | نسبة عمولة التطبيق (0–100) من مبلغ الخدمة قبل الضريبة | `10` |

يتم إنشاء/تحديث هذه القيم عند تشغيل الـ seed؛ ويمكن للأدمن تعديلها لاحقاً إذا وُجدت واجهة لإعدادات النظام.

---

## استخدام نسبة الضريبة 14.5% في الكود

- **الحجوزات:** في `booking.controller.js` يتم جلب نسبة الضريبة عبر `getVatRate()` من `src/utils/pricing.js` واستخدامها في حساب `tax` و`totalPrice`.
- **طلبات المتجر:** في `marketplaceOrder.service.js` يتم استخدام `getVatRate()` لحساب `tax` في إنشاء وتحديث الطلب.

الدالة `getVatRate()` تقرأ من إعداد النظام `VAT_RATE` أو ترجع الافتراضي 0.145.

---

## المحفظة والنقاط

- **المحفظة:** موديل `Wallet` (رصيد متاح، رصيد معلق، نقاط). API: `GET /api/wallets` لمحفظة المستخدم الحالي.
- **المعاملات:** `Transaction` و`PointTransaction` لتسجيل الحركات.
- **نقاط التحويل:** إعداد `POINTS_CONVERSION_RATE` (من لوحة الأدمن – المالية – إعدادات النقاط).

---

## ملخص التدفق

1. **العميل يدفع:** إجمالي = مجموع الخدمات (بعد الخصم) + رسوم إضافية + ضريبة 14.5%.
2. **التطبيق يأخذ:** عمولة المنصة = نسبة من مبلغ الخدمة (قبل الضريبة).
3. **الفيندور يستلم:** صافي = مبلغ خدماته بعد خصم عمولة التطبيق.
4. **الضريبة:** تُحسب على الفاتورة للعميل وتُدفع للجهة الضريبية حسب السياسة المحاسبية للمنصة.

لتفصيل الحسابات برمجياً يمكن استخدام:

```js
const { computeServiceBreakdown } = require('./utils/pricing');
const breakdown = await computeServiceBreakdown(subtotal, { discount, flatFee });
// breakdown: totalForCustomer, vendorEarnings, platformCommission, tax, taxRate, ...
```

---

## كيف يتحكم الأدمن بالضريبة وعمولة التطبيق

الأدمن يتحكم في **نسبة الضريبة** و**نسبة عمولة التطبيق** عبر إعدادات النظام (System Settings). المسارات التالية مخصّصة للأدمن فقط (يتطلب تسجيل دخول بدور `ADMIN`).

### 1) عرض كل الإعدادات (بما فيها التسعير)

```http
GET /api/admin/settings
Authorization: Bearer <admin_token>
```

الاستجابة تحتوي على إعدادات مجمّعة حسب الفئة؛ منها فئة `PRICING` التي تضم:
- `VAT_RATE` — نسبة الضريبة (مخزّنة كنسبة 0–1، مثلاً 0.145 = 14.5%)
- `PLATFORM_COMMISSION_PERCENT` — نسبة عمولة التطبيق (مثلاً 10 = 10%)

### 2) عرض إعدادات التسعير فقط

```http
GET /api/admin/settings/pricing
Authorization: Bearer <admin_token>
```

يعيد فقط إعدادات فئة `PRICING` (الضريبة والعمولة) مع الوصف بالعربي والإنجليزي و`isEditable`.

### 3) تعديل إعداد (ضريبة أو عمولة)

```http
PUT /api/admin/settings/VAT_RATE
Authorization: Bearer <admin_token>
Content-Type: application/json

{ "value": "0.145" }
```

أو لتعديل نسبة العمولة:

```http
PUT /api/admin/settings/PLATFORM_COMMISSION_PERCENT
Authorization: Bearer <admin_token>
Content-Type: application/json

{ "value": "10" }
```

- **VAT_RATE:** يُمرَّر كنسبة مئوية (مثلاً 14.5% → `"14.5"` أو `14.5`). الباكند يحوّلها داخلياً لـ 0.145 عند الحساب.
- **PLATFORM_COMMISSION_PERCENT:** يُمرَّر كنسبة مئوية (مثلاً 10% → `"10"` أو `10`).

بعد الحفظ، أي حساب ضريبة أو عمولة جديد (حجوزات، طلبات متجر) يستخدم القيم المحدّثة تلقائياً.
